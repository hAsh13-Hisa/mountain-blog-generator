# 低山旅行自動記事作成アプリ 要件定義書 v3.0

**プロジェクト名**: 低山旅行自動記事作成アプリ (Mountain Blog Generator)  
**バージョン**: 3.0  
**作成日**: 2025年6月10日  
**最終更新**: 2025年6月11日  

## 1. プロジェクト概要

### 1.1 目的
日本の低山登山に関する高品質なブログ記事を自動生成し、楽天アフィリエイトリンクを含めてWordPressサイトに自動投稿するシステムを構築する。

### 1.2 背景
- 山登り・ハイキング情報の需要増加
- SEO対策された記事の継続的な投稿の必要性
- アフィリエイト収益の自動化
- 記事作成にかかる時間とコストの削減

### 1.3 プロジェクトスコープ
- 低山（標高2000m以下中心）の登山記事作成
- 楽天アフィリエイト収益化（商品画像付き表示）
- WordPress自動投稿システム（Cocoonテーマ対応）
- 単発記事生成機能

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 記事自動生成機能 ✅
- **Claude AI API（Claude-3.5-Sonnet）**を使用した高品質な記事生成
- 山の基本情報（標高、所在地、難易度）を含む構造化された記事
- SEO最適化されたタイトル・メタディスクリプション
- 季節・テーマに応じた記事バリエーション
- 文字数: 2000-3000文字程度
- **マルチキーワード対応**（スペース区切り・カンマ区切り）

#### 2.1.2 アフィリエイトリンク自動挿入機能 ✅
- **楽天アフィリエイトAPI**を使用した商品情報取得
- **商品画像付きアフィリエイト表示**（80x80px サムネイル）
- 登山用品（ウェア、シューズ、バックパック等）の自動選定
- **価格非表示**（変動リスク回避）
- 番号付きレイアウト（#1, #2, #3...）
- **インラインCSS**によるテーマ非依存スタイリング
- ホバーエフェクト・視覚的改善

#### 2.1.3 画像自動取得機能 ✅
- **Unsplash API**を使用した山・自然系画像の取得
- アイキャッチ画像の自動設定
- 記事内容に適した画像の選定
- 画像の代替テキスト自動生成

#### 2.1.4 WordPress自動投稿機能 ✅
- **WordPress WXR（XML Export）形式**での記事投稿
- **Cocoonテーマ完全対応**
- カテゴリ・タグの自動設定
- SEOメタデータの設定
- **Featured Image from URL**プラグイン対応
- **アイキャッチ画像誤検出防止**（商品画像との分離）

### 2.2 データ管理機能

#### 2.2.1 山マスターデータ ✅
- **日本全国47都道府県の低山情報データベース**
- **67山の詳細データ**（20山から大幅拡張）
- 基本情報：標高、所在地、難易度、アクセス情報
- **穴場情報・隠れた名山**を含む
- **2000m以下基準**の低山中心
- JSON形式での管理（`mountains_japan_expanded.json`）

#### 2.2.2 記事履歴管理 ✅
- 生成済み記事の履歴保存
- JSON + HTML + XML 同時出力
- 記事内容の再編集・再利用機能

### 2.3 単発記事生成機能 ✅
- **simple_article_generator.py** による1記事生成
- 山ID + テーマ指定での記事作成
- JSON・HTML・WordPress XML 同時出力
- プレビュー機能付き

## 3. 技術要件

### 3.1 開発環境
- **言語**: Python 3.12.3
- **アーキテクチャ**: Clean Architecture
- **環境**: WSL2 Ubuntu + venv

### 3.2 外部API・サービス

#### 3.2.1 Claude API ✅
- **プロバイダー**: Anthropic
- **モデル**: Claude-3.5-Sonnet
- **用途**: 高品質な記事生成
- **認証**: APIキー認証
- **ライブラリ**: anthropic 0.53.0

#### 3.2.2 楽天API ✅
- **サービス**: 楽天アフィリエイトAPI
- **用途**: 商品情報・画像取得、アフィリエイトリンク生成
- **認証**: アプリケーションID + アフィリエイトID
- **新機能**: 商品画像URLの取得・表示

#### 3.2.3 Unsplash API ✅
- **用途**: 山・自然系画像の取得
- **形式**: 固定サンプル画像（高品質）
- **画像サイズ**: 1024x576px（アイキャッチ用）

#### 3.2.4 WordPress ✅
- **方式**: WXR形式によるXMLインポート
- **対象サイト**: https://teizan.abg.ooo
- **認証**: 管理画面での手動インポート
- **テーマ**: Cocoon（完全対応）
- **プラグイン**: Featured Image from URL

### 3.3 技術スタック

#### 3.3.1 バックエンド ✅
- **Python**: 3.12.3
- **HTTP Client**: requests
- **設定管理**: pydantic-settings
- **ログ**: logging + colorlog

#### 3.3.2 データフォーマット ✅
- **設定**: JSON形式
- **記事出力**: JSON + HTML + WordPress XML
- **ログ**: 構造化ログ（JSON）

## 4. 非機能要件

### 4.1 パフォーマンス ✅
- 1記事の生成時間: 25-30秒
- 商品画像表示: 瞬時ロード
- アフィリエイト商品取得: 5件まで

### 4.2 可用性 ✅
- API障害時の適切なエラーハンドリング
- 生成途中での中断・再開機能
- ログによる詳細な処理追跡

### 4.3 保守性 ✅
- Clean Architectureによる保守しやすい設計
- 設定の外部化（環境変数）
- 包括的なログ出力
- エラーハンドリングの統一

### 4.4 セキュリティ ✅
- APIキーの環境変数管理
- 秘密情報のログ出力防止
- 入力値の適切なバリデーション

## 5. システム構成

### 5.1 アーキテクチャ ✅
```
mountain_blog_generator/
├── config/                 # 設定管理
│   ├── settings.py        # 環境変数・設定
│   └── logging_config.py  # ログ設定
├── src/
│   ├── domain/            # ドメイン層
│   │   └── entities.py    # エンティティ
│   ├── application/       # アプリケーション層
│   │   └── services.py    # ビジネスロジック
│   ├── infrastructure/    # インフラ層
│   │   ├── repositories.py # データアクセス
│   │   └── api_clients.py # 外部API
│   └── presentation/      # プレゼンテーション層
│       ├── web/           # Flask Web UI
│       └── cli.py         # CLI
├── data/                  # マスターデータ
│   └── mountains_japan_expanded.json # 67山データ
├── logs/                  # ログファイル
├── simple_article_generator.py # 単発記事生成
└── wordpress_import_generator_v2.py # 複数記事生成
```

### 5.2 データフロー ✅
1. **入力**: 山ID + テーマ選択
2. **処理**: Claude API → 記事生成
3. **拡張**: 楽天API → アフィリエイトリンク・画像追加
4. **画像**: Unsplash → アイキャッチ画像取得
5. **出力**: JSON + HTML + WordPress XML同時生成
6. **投稿**: WordPress手動インポート → 即時公開

## 6. 特殊対応・制約事項

### 6.1 Cocoonテーマ対応 ✅
- **問題**: Cocoonが記事内最初の画像をアイキャッチに自動設定
- **解決策**: 記事冒頭に非表示アイキャッチ画像を配置
- **実装**: `style="display:none;"` による非表示画像
- **効果**: 正しいアイキャッチ画像の保証

### 6.2 アフィリエイト表示最適化 ✅
- **商品画像**: 楽天APIから自動取得・表示
- **価格表示**: 意図的に非表示（変動対応）
- **レイアウト**: Flexbox + インラインCSS
- **視覚効果**: ホバーエフェクト・シャドウ

### 6.3 技術的制約 ✅
- Python 3.12.3 + WSL2環境での動作
- 外部API依存（Claude、楽天、Unsplash）
- WordPress WXRインポート方式による投稿
- Cocoonテーマでの動作保証

## 7. 実装済み機能一覧

### 7.1 記事生成 ✅ 完了
- [x] Claude AI による高品質記事生成
- [x] マルチキーワード対応
- [x] SEO最適化タイトル・概要
- [x] 2000-3000文字の適切な文章量

### 7.2 アフィリエイト機能 ✅ 完了
- [x] 楽天API商品検索・取得
- [x] **商品画像付き表示**
- [x] **価格非表示実装**
- [x] **インラインCSS対応**
- [x] **ホバーエフェクト実装**

### 7.3 WordPress連携 ✅ 完了
- [x] WXR形式XML生成
- [x] Featured Image from URLプラグイン対応
- [x] **Cocoonテーマ完全対応**
- [x] **アイキャッチ画像誤検出防止**

### 7.4 データベース ✅ 完了
- [x] **67山データベース完成**
- [x] **全47都道府県カバー**
- [x] **穴場・隠れた名山情報**
- [x] **2000m以下低山中心**

### 7.5 ユーザビリティ ✅ 完了
- [x] 単発記事生成ツール
- [x] 複数記事一括生成
- [x] HTMLプレビュー機能
- [x] JSON・XML同時出力

## 8. 成功基準

### 8.1 機能面 ✅ 達成
- [x] 高品質な記事の自動生成
- [x] **商品画像付きアフィリエイト表示**
- [x] **Cocoonテーマでの完全動作**
- [x] **アイキャッチ画像の正確な設定**
- [x] WordPress記事の正常な投稿

### 8.2 品質面 ✅ 達成
- [x] 生成記事のSEO最適化
- [x] 自然で読みやすい文章品質
- [x] **視覚的に美しいアフィリエイト表示**
- [x] エラーハンドリングの適切な実装

### 8.3 運用面 ✅ 達成
- [x] **67山データベースの充実**
- [x] 単発・複数記事生成機能
- [x] 安定した記事生成処理
- [x] **Cocoonテーマ環境での安定動作**

## 9. 主要改善点（v2.0→v3.0）

### 9.1 アフィリエイト機能強化 ✅
- **商品画像表示**: 楽天APIから画像URL取得・80x80px表示
- **価格非表示**: セール・変動対応でよりユーザーフレンドリーに
- **視覚改善**: インラインCSS・ホバーエフェクト実装
- **商品名最適化**: プロモーション文言の自動除去

### 9.2 WordPress対応強化 ✅
- **Cocoonテーマ対応**: アイキャッチ画像誤検出問題の完全解決
- **非表示画像配置**: 記事冒頭での正確なアイキャッチ設定
- **インラインCSS**: テーマ変更の影響を受けない独立スタイル

### 9.3 データベース大幅拡張 ✅
- **20山→67山**: 全国47都道府県をカバー
- **穴場情報**: 隠れた名山・知る人ぞ知るスポット追加
- **2000m以下基準**: より低山・ハイキング向けに特化

### 9.4 機能の簡素化 ✅
- **予約投稿廃止**: 複雑なスケジュール機能を削除
- **単発生成重視**: simple_article_generator.pyで即座に記事作成
- **即時インポート**: WordPress手動インポートで確実な投稿

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|-------|
| 1.0 | 2025年6月9日 | 初版作成、基本機能定義 | Claude Code |
| 2.0 | 2025年6月10日 | 完成版、全機能実装完了、スケジュール投稿対応、XML形式対応 | Claude Code |
| **3.0** | **2025年6月11日** | **商品画像付きアフィリエイト実装、Cocoonテーマ対応、67山データベース拡張、単発記事生成重視** | **Claude Code** |

---

**承認者**: aime  
**プロジェクトステータス**: ✅ 完了・最適化済み  
**次フェーズ**: 本格運用開始